<view class="anniversary-container">
  <!-- é¡¶éƒ¨èƒŒæ™¯ -->
  <view class="bg-top"></view>

  <!-- æ—¥å†ç»„ä»¶ -->
  <view class="calendar-section">
    <van-calendar
      show-title="{{ false }}"
      show-confirm="{{ false }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      formatter="{{ formatter }}"
      bind:select="onSelectDate"
      class="calendar"
      poppable="{{ false }}"
      show-mark="{{ false }}"
      safe-area-inset-bottom="{{ false }}"
    />
  </view>

  <!-- çºªå¿µæ—¥åˆ—è¡¨ -->
  <view class="anniversary-list">
    <view class="list-header">
      <text class="title">æˆ‘çš„çºªå¿µæ—¥</text>
      <view class="add-btn" bindtap="showAddPopup">
        <van-icon name="plus" color="#FF69B4" size="40rpx" />
      </view>
    </view>

    <!-- åˆ—è¡¨å†…å®¹ -->
    <view class="list-content">
      <view class="loading-container" wx:if="{{ loading }}">
        <van-loading type="spinner" color="#FF69B4" size="24px">åŠ è½½ä¸­...</van-loading>
      </view>
      <block wx:elif="{{ anniversaryList && anniversaryList.length > 0 }}">
        <view 
          class="anniversary-item" 
          wx:for="{{ anniversaryList }}" 
          wx:key="id" 
          catchtap="showDetailPopup" 
          data-item="{{ item }}"
          hover-class="item-hover"
        >
          <view class="item-left">
            <view class="item-type" style="background: {{ item.type === 0 ? '#FF69B4' : item.type === 1 ? '#FFB6C1' : '#FFC0CB' }}">
              {{ item.type === 0 ? 'æ‹çˆ±' : item.type === 1 ? 'ç”Ÿæ—¥' : 'å…¶ä»–' }}
            </view>
            <view class="item-info">
              <text class="item-title">{{ item.title }}</text>
              <text class="item-date">{{ item.date }}</text>
            </view>
          </view>
          <view class="item-right">
            <text class="days-text" wx:if="{{ item.daysUntil > 0 }}">è¿˜æœ‰{{ item.daysUntil }}å¤©</text>
            <text class="days-text today" wx:elif="{{ item.daysUntil === 0 }}">å°±æ˜¯ä»Šå¤©</text>
            <text class="days-text passed" wx:else>å·²è¿‡å»{{ -item.daysUntil }}å¤©</text>
            <van-icon name="arrow" color="#999" />
          </view>
        </view>
      </block>
      <view class="empty-container" wx:else>
        <image class="empty-image" src="/static/images/empty.png" mode="aspectFit"></image>
        <text class="empty-text">è¿˜æ²¡æœ‰æ·»åŠ çºªå¿µæ—¥å“¦~</text>
        <text class="empty-text">å¿«æ¥è®°å½•ä½ ä»¬çš„ç¬¬ä¸€ä¸ªçºªå¿µæ—¥å§</text>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘å¼¹çª— -->
  <van-popup
    show="{{ showAddPopup }}"
    position="bottom"
    bind:close="onCloseAddPopup"
    custom-style="min-height: 60%;"
    round
  >
    <view class="popup-content edit-popup">
      <view class="popup-header">
        <view class="popup-title">
          <van-icon name="{{ isEdit ? 'edit' : 'plus' }}" size="40rpx" color="#ff4d94" />
          <text>{{ isEdit ? 'ç¼–è¾‘çºªå¿µæ—¥' : 'æ·»åŠ çºªå¿µæ—¥' }}</text>
        </view>
        <van-icon name="cross" size="40rpx" color="#999" bindtap="onCloseAddPopup" />
      </view>
      
      <!-- è¡¨å•å†…å®¹ -->
      <view class="edit-form">
        <view class="form-item">
          <view class="form-label">
            <van-icon name="label-o" color="#ff4d94" size="36rpx" />
            <text>æ ‡é¢˜</text>
          </view>
          <input 
            class="form-input"
            placeholder="è¯·è¾“å…¥çºªå¿µæ—¥æ ‡é¢˜"
            value="{{ newAnniversary.title }}"
            bindinput="onTitleInput"
          />
        </view>
        
        <view class="form-item" bindtap="onShowDatePicker">
          <view class="form-label">
            <van-icon name="calendar-o" color="#ff4d94" size="36rpx" />
            <text>æ—¥æœŸ</text>
          </view>
          <view class="form-value">
            <text>{{ newAnniversary.date || 'è¯·é€‰æ‹©æ—¥æœŸ' }}</text>
            <van-icon name="arrow" color="#999" />
          </view>
        </view>
        
        <view class="form-item" bindtap="onShowTypePicker">
          <view class="form-label">
            <van-icon name="bookmark-o" color="#ff4d94" size="36rpx" />
            <text>ç±»å‹</text>
          </view>
          <view class="form-value">
            <text>{{ typeOptions[newAnniversary.type] }}</text>
            <van-icon name="arrow" color="#999" />
          </view>
        </view>
        
        <view class="form-item" bindtap="onShowRepeatPicker">
          <view class="form-label">
            <van-icon name="replay" color="#ff4d94" size="36rpx" />
            <text>é‡å¤</text>
          </view>
          <view class="form-value">
            <text>{{ repeatOptions[newAnniversary.repeatType] }}</text>
            <van-icon name="arrow" color="#999" />
          </view>
        </view>
        
        <view class="form-item" bindtap="onShowReminderPicker">
          <view class="form-label">
            <van-icon name="bell" color="#ff4d94" size="36rpx" />
            <text>æé†’</text>
          </view>
          <view class="form-value">
            <text>{{ reminderOptions[reminderIndex] }}</text>
            <van-icon name="arrow" color="#999" />
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="popup-buttons">
        <button class="btn-cancel" bindtap="onCloseAddPopup">
          <van-icon name="close" size="32rpx" />
          <text>å–æ¶ˆ</text>
        </button>
        <button class="btn-confirm" bindtap="onConfirmPopup">
          <van-icon name="success" size="32rpx" />
          <text>{{ isEdit ? 'ä¿å­˜' : 'æ·»åŠ ' }}</text>
        </button>
      </view>
    </view>
  </van-popup>

  <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
  <van-popup
    show="{{ showDatePicker }}"
    position="bottom"
    bind:close="onCloseDatePicker"
  >
    <van-datetime-picker
      type="date"
      value="{{ currentDate }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="onConfirmDatePicker"
      bind:cancel="onCloseDatePicker"
    />
  </van-popup>

  <!-- ç±»å‹é€‰æ‹©å™¨ -->
  <van-popup
    show="{{ showTypePicker }}"
    position="bottom"
    bind:close="onCloseTypePicker"
  >
    <van-picker
      show-toolbar
      columns="{{ typeOptions }}"
      bind:confirm="onConfirmTypePicker"
      bind:cancel="onCloseTypePicker"
    />
  </van-popup>

  <!-- é‡å¤ç±»å‹é€‰æ‹©å™¨ -->
  <van-popup
    show="{{ showRepeatPicker }}"
    position="bottom"
    bind:close="onCloseRepeatPicker"
  >
    <van-picker
      show-toolbar
      columns="{{ repeatOptions }}"
      bind:confirm="onConfirmRepeatPicker"
      bind:cancel="onCloseRepeatPicker"
    />
  </van-popup>

  <!-- æé†’é€‰æ‹©å™¨ -->
  <van-popup
    show="{{ showReminderPicker }}"
    position="bottom"
    bind:close="onCloseReminderPicker"
  >
    <van-picker
      show-toolbar
      columns="{{ reminderOptions }}"
      bind:confirm="onConfirmReminderPicker"
      bind:cancel="onCloseReminderPicker"
    />
  </van-popup>

  <!-- çºªå¿µæ—¥è¯¦æƒ…å¼¹çª— -->
  <van-popup
    show="{{ showDetailPopup }}"
    position="bottom"
    round
    custom-style="min-height: 45%;"
    bind:close="onCloseDetailPopup"
  >
    <view class="popup-content detail-popup">
      <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
      <view class="popup-header">
        <view class="popup-title">
          <van-icon name="clock" size="40rpx" color="#ff4d94" />
          <text>çºªå¿µæ—¥è¯¦æƒ…</text>
        </view>
        <van-icon name="cross" size="40rpx" color="#999" bindtap="onCloseDetailPopup" />
      </view>

      <!-- è¯¦æƒ…å†…å®¹ -->
      <view class="detail-content">
        <!-- å€’è®¡æ—¶æ˜¾ç¤º -->
        <view class="countdown-section">
          <block wx:if="{{ currentAnniversary.daysUntil === 0 }}">
            <text class="countdown-text">ğŸ‰ å°±æ˜¯ä»Šå¤© ğŸ‰</text>
          </block>
          <block wx:elif="{{ currentAnniversary.daysUntil > 0 }}">
            <text class="countdown-number">{{ currentAnniversary.daysUntil }}</text>
            <text class="countdown-text">å¤©å</text>
          </block>
          <block wx:else>
            <text class="countdown-number">{{ -currentAnniversary.daysUntil }}</text>
            <text class="countdown-text">å¤©å‰</text>
          </block>
        </view>

        <!-- è¯¦æƒ…åˆ—è¡¨ -->
        <view class="detail-list">
          <view class="detail-item">
            <view class="detail-label">
              <van-icon name="label-o" color="#ff4d94" size="36rpx" />
              <text>æ ‡é¢˜</text>
            </view>
            <view class="detail-value highlight-text">{{ currentAnniversary.title }}</view>
          </view>

          <view class="detail-item">
            <view class="detail-label">
              <van-icon name="calendar-o" color="#ff4d94" size="36rpx" />
              <text>æ—¥æœŸ</text>
            </view>
            <view class="detail-value">{{ currentAnniversary.date }}</view>
          </view>

          <view class="detail-item">
            <view class="detail-label">
              <van-icon name="bookmark-o" color="#ff4d94" size="36rpx" />
              <text>ç±»å‹</text>
            </view>
            <view class="detail-value">
              <view class="type-tag" style="background: {{ currentAnniversary.type === 0 ? '#ff4d94' : currentAnniversary.type === 1 ? '#ff6b6b' : '#ffb6c1' }}">
                {{ typeOptions[currentAnniversary.type] }}
              </view>
            </view>
          </view>

          <view class="detail-item">
            <view class="detail-label">
              <van-icon name="replay" color="#ff4d94" size="36rpx" />
              <text>é‡å¤</text>
            </view>
            <view class="detail-value">{{ repeatOptions[currentAnniversary.repeatType] }}</view>
          </view>

          <view class="detail-item">
            <view class="detail-label">
              <van-icon name="bell" color="#ff4d94" size="36rpx" />
              <text>æé†’</text>
            </view>
            <view class="detail-value">{{ reminderOptions[getReminderIndex(currentAnniversary.reminderDays)] }}</view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="popup-buttons">
        <button class="btn-delete" bindtap="onDeleteAnniversary">
          <van-icon name="delete" size="32rpx" />
          <text>åˆ é™¤</text>
        </button>
        <button class="btn-edit" bindtap="onEditAnniversary">
          <van-icon name="edit" size="32rpx" />
          <text>ç¼–è¾‘</text>
        </button>
      </view>
    </view>
  </van-popup>
</view>